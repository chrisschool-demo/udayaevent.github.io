<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Event Wallet</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 
      REMOVED external scripts from here. They are now at the end of <body>.
    -->

    <style>
        /* Base view style */
        .view { display: none; }
        /* Style for printing the QR Card */
        @media print {
            body * { visibility: hidden; }
            #qr-card-view, #qr-card-view * { visibility: visible; }
            #qr-card-view {
                position: absolute; left: 0; top: 0; width: 100%; height: 100%;
                display: flex !important; justify-content: center; align-items: center;
            }
            #qr-card-controls { display: none !important; }
            #qr-card-container { border: 2px dashed #333 !important; }
        }
        /* Fix for scanner layout */
        .scanner-viewport {
            width: 100%; border: 2px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden;
        }
        /* NEW: Style for Gemini analysis box */
        .analysis-box {
            background-color: #f3e8ff; /* Light purple */
            border: 1px solid #d8b4fe; /* Purple border */
            color: #581c87; /* Dark purple text */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            white-space: pre-wrap; /* Preserves formatting from the LLM */
            font-family: monospace;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">

    <!-- Main Container -->
    <div class="container mx-auto p-4 min-h-screen flex items-center justify-center">
        <div class="max-w-lg w-full bg-white p-6 md:p-8 rounded-xl shadow-2xl">

            <!-- View: Loading -->
            <div id="loading-view" class="view" style="display: block;">
                <h1 class="text-2xl font-bold text-center text-indigo-600">Annual Day Wallet</h1>
                <p id="loading-message" class="text-center text-gray-600 mt-4">Connecting to event database...</p>
            </div>

            <!-- View: Main Menu -->
            <div id="main-menu-view" class="view">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Event Wallet Menu</h1>
                <div class="space-y-4">
                    <button id="goto-admin-btn" class="w-full bg-indigo-600 text-white py-4 rounded-lg text-lg font-semibold hover:bg-indigo-700 transition duration-300 shadow-md flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        Admin Panel
                    </button>
                    <button id="goto-stall-btn" class="w-full bg-green-600 text-white py-4 rounded-lg text-lg font-semibold hover:bg-green-700 transition duration-300 shadow-md flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                        Stall Panel
                    </button>
                    <button id="goto-student-btn" class="w-full bg-blue-600 text-white py-4 rounded-lg text-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                        Student Panel
                    </button>
                </div>
            </div>

            <!-- View: Admin Panel -->
            <div id="admin-view" class="view">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Admin Panel</h1>
                <div id="admin-message" class="text-center mb-4"></div>
                <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">

                    <!-- 1. Approve Pending Recharges (NEW) -->
                    <div class="p-4 border-2 border-green-400 rounded-lg bg-green-50">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Approve Pending Recharges</h2>
                        <div id="pending-recharges-list" class="space-y-3 max-h-48 overflow-y-auto">
                            <!-- Pending recharges will be injected here -->
                        </div>
                    </div>

                    <!-- 2. Manual Cash Recharge (NEW) -->
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Manual Cash Recharge</h2>
                        <button id="goto-manual-recharge-btn" class="w-full bg-yellow-500 text-white py-3 rounded-lg font-semibold hover:bg-yellow-600 transition">
                            Open Cash Recharge Station
                        </button>
                    </div>

                    <!-- 3. Register Student -->
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Register New Student</h2>
                        <form id="register-student-form" class="space-y-3" autocomplete="off">
                            <input type="text" id="student-name" placeholder="Student Name" class="w-full p-3 border border-gray-300 rounded-lg" required>
                            <input type="text" id="student-school-id" placeholder="Student School ID (e.g., S-101)" class="w-full p-3 border border-gray-300 rounded-lg" required>
                            <input type="number" id="initial-balance" inputmode="decimal" placeholder="Initial Balance (e.g., 500)" class="w-full p-3 border border-gray-300 rounded-lg" required min="0" step="10">
                            <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">Register & Generate QR Card</button>
                        </form>
                    </div>

                    <!-- 3. Find Student / Re-print Card (NEW) -->
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Find Student / Re-print Card</h2>
                        <form id="find-student-form" class="flex gap-2" autocomplete="off">
                            <input type="text" id="find-student-query" placeholder="Search by Name or School ID" class="w-full p-3 border border-gray-300 rounded-lg">
                            <button type="submit" class="bg-blue-600 text-white px-4 rounded-lg font-semibold hover:bg-blue-700 transition">Find</button>
                        </form>
                        <div id="find-student-results" class="mt-4 max-h-40 overflow-y-auto">
                            <!-- Search results will be injected here -->
                        </div>
                    </div>
                    
                    <!-- 4. Manage Menu Items (NEW) -->
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Manage Menu Items</h2>
                        <form id="add-menu-item-form" class="space-y-3" autocomplete="off">
                            <input type="text" id="menu-item-stall-name" placeholder="Stall Name (e.g., Food Stall 1)" class="w-full p-3 border border-gray-300 rounded-lg" required>
                            <input type="text" id="menu-item-name" placeholder="Item Name (e.g., Samosa)" class="w-full p-3 border border-gray-300 rounded-lg" required>
                            <input type="number" id="menu-item-price" inputmode="decimal" placeholder="Price (e.g., 15)" class="w-full p-3 border border-gray-300 rounded-lg" required min="1">
                            <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">Add Menu Item</button>
                        </form>
                        <h3 class="text-lg font-semibold text-gray-600 mt-6 mb-2">Current Menu</h3>
                        <div id="menu-items-list" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- Menu items will be injected here -->
                        </div>
                    </div>
                    
                    <!-- 5. View Reports -->
                    <div class="p-4 border rounded-lg bg-gray-50">
                         <h2 class="text-xl font-semibold text-gray-700 mb-4">Event Reports</h2>
                         <div class="space-y-3">
                            <button id="view-all-students-btn" class="w-full bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition">View All Student Balances</button>
                            <button id="view-all-transactions-btn" class="w-full bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition">View Transaction History</button>
                            <button id="view-stall-performance-btn" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition">View Stall Performance</button>
                        </div>
                    </div>
                </div>
                
                <button id="admin-back-btn" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition mt-6">
                    Back to Main Menu
                </button>
            </div>
            
            <!-- View: Manual Recharge (NEW) -->
            <div id="manual-recharge-view" class="view">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Manual Cash Recharge</h1>
                <div id="recharge-message" class="text-center mb-4"></div>

                <!-- Scanner -->
                <div id="recharge-scanner-container">
                    <p class="text-center text-gray-600 mb-2">Scan Student's QR Card</p>
                    <div id="recharge-scanner" class="scanner-viewport"></div>
                </div>

                <!-- Recharge Form (hidden until scan) -->
                <form id="recharge-form" class="space-y-4 mt-4" style="display: none;" autocomplete="off">
                    <div class="text-center bg-gray-50 p-4 rounded-lg">
                        <p class="text-lg font-medium text-gray-700">Student: <strong id="recharge-student-name" class="text-indigo-600"></strong></p>
                        <p class="text-2xl font-bold text-gray-900">Current Balance: <strong id="recharge-current-balance"></strong></p>
                    </div>
                    <input type="number" id="recharge-amount" inputmode="decimal" placeholder="Amount to Add (e.g., 200)" class="w-full p-3 border border-gray-300 rounded-lg" required min="1">
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">Confirm Cash Recharge</button>
                    <button type="button" id="recharge-cancel-btn" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">Cancel (Scan Next)</button>
                </form>

                <button id="recharge-back-btn" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition mt-8">
                    Back to Admin Panel
                </button>
            </div>

            <!-- View: Cash Out Confirmation (NEW) -->
            <div id="cash-out-view" class="view">
                <h1 class="text-2xl font-bold text-center text-red-600 mb-6">Confirm Cash Out</h1>
                <div id="cash-out-message" class="text-center mb-4"></div>
                <div class="text-center bg-red-50 p-6 rounded-lg border border-red-200 space-y-3">
                    <p class="text-xl font-medium text-gray-700">Student: <strong id="cash-out-student-name" class="text-gray-900"></strong></p>
                    <p class="text-3xl font-bold text-red-600">Refund Amount: <strong id="cash-out-balance"></strong></p>
                    <p class="text-sm text-gray-600">Hand this amount in cash to the student. Clicking confirm will set their balance to zero.</p>
                </div>
                <div class="flex gap-4 mt-6">
                    <button id="cancel-cash-out-btn" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                        Cancel
                    </button>
                    <button id="confirm-cash-out-btn" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition">
                        Confirm Cash Out
                    </button>
                </div>
            </div>

            <!-- View: Stall Panel -->
            <div id="stall-view" class="view">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Stall Panel</h1>
                <div id="stall-message" class="text-center mb-4"></div>

                <!-- Stall Setup -->
                <div id="stall-setup" class="space-y-4">
                    <input type="text" id="stall-name" placeholder="Enter Your Stall Name (e.g., Food Stall 1)" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <button id="stall-start-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">Start Session</button>
                </div>

                <!-- Stall Active -->
                <div id="stall-active" style="display: none;">
                    <p id="stall-active-name" class="text-center font-semibold text-gray-700 mb-4"></p>
                    
                    <!-- Item List with Quantities -->
                    <div class="space-y-2">
                        <h3 class="text-lg font-semibold text-gray-700 text-center">Select Items</h3>
                        <div id="stall-item-list" class="space-y-3 max-h-40 overflow-y-auto p-3 border rounded-lg bg-gray-50 mb-4">
                            <!-- Stall menu items with qty selectors will be injected here -->
                        </div>
                    </div>

                    <!-- Total Amount -->
                    <div class="text-center bg-indigo-50 p-4 rounded-lg mb-4">
                        <p class="text-xl font-medium text-gray-700">TOTAL AMOUNT</p>
                        <p id="stall-total-amount" class="text-4xl font-bold text-indigo-600">₹0.00</p>
                    </div>

                    <!-- Scanner -->
                    <div id="stall-scanner-container">
                        <p class="text-center text-gray-600 mb-2">Scan Student's QR Card</p>
                        <div id="stall-scanner" class="scanner-viewport"></div>
                    </div>

                    <!-- Payment Form (hidden until scan) -->
                    <form id="stall-payment-form" class="space-y-4 mt-4" style="display: none;" autocomplete="off">
                        <div class="text-center bg-gray-50 p-4 rounded-lg">
                            <p class="text-lg font-medium text-gray-700">Student: <strong id="payment-student-name" class="text-indigo-600"></strong></p>
                            <p class="text-2xl font-bold text-gray-900">Balance: <strong id="payment-current-balance"></strong></p>
                        </div>
                        
                        <button type="submit" id="stall-confirm-payment-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                            Confirm Payment (₹0.00)
                        </button>
                        <button type="button" id="stall-cancel-btn" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">Cancel (Scan Next)</button>
                    </form>
                </div>
                
                <button id="stall-back-btn" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition mt-8">
                    Back to Main Menu
                </button>
            </div>
            
            <!-- View: Student Panel -->
            <div id="student-view" class="view">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Student Panel</h1>
                <div id="student-message" class="text-center mb-4"></div>

                <!-- Student Login -->
                <div id="student-login-view">
                    <p class="text-center text-gray-600 mb-4">Scan your event card to see your balance and history.</p>
                    <button id="student-scan-login-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition mb-4">Scan My Card</button>
                    <div id="student-scanner" class="scanner-viewport" style="display: none;"></div>
                    <div id="student-scanner-controls" class="mt-2" style="display: none;">
                        <button id="student-scan-cancel-btn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Cancel Scan</button>
                    </div>
                </div>
                
                <!-- Student Dashboard -->
                <div id="student-dashboard-view" class="bg-gray-50 p-6 rounded-lg" style="display: none;">
                    <div class="text-center">
                        <p class="text-xl font-medium text-gray-700">Welcome, <strong id="student-dash-name" class="text-indigo-600"></strong></p>
                        <p class="text-3xl font-bold text-gray-900 mt-2">Balance: <strong id="student-dash-balance"></strong></p>
                    </div>
                    <hr class="my-4">
                    <h3 class="text-md font-semibold text-gray-700 mb-2 text-center">My Recent Transactions</h3>
                    <div id="student-dash-transactions" class="max-h-40 overflow-y-auto">
                        <!-- Recent transactions will be injected here -->
                    </div>
                    
                    <!-- NEW: Gemini Student Spending Analyzer -->
                    <button id="student-analyze-btn" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition mt-6">
                        ✨ Analyze My Spending
                    </button>
                    <div id="student-analysis-box" class="analysis-box" style="display: none;"></div>
                    
                    <!-- Student Recharge Portal (NEW) -->
                    <button id="student-recharge-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition mt-6">
                        Recharge My Card
                    </button>
                    <div id="student-recharge-portal" class="mt-4 p-4 border-2 border-dashed border-green-400 rounded-lg bg-green-50" style="display: none;">
                        <p class="text-md font-semibold text-green-700 text-center">1. Pay the amount you want to add:</p>
                        
                        <!-- 
                            =======================================================================
                            === IMPORTANT: PASTE YOUR UPLOADED QR CODE IMAGE URL HERE             ===
                            =======================================================================
                            Upload your UPI QR code (1000140068.png) to a free image host
                            (like https://imgur.com/upload) and paste the 'Direct Link'
                            into the src="..." below, replacing the placehold.co URL.
                        -->
                        <img src="https://placehold.co/200x200/png?text=PASTE+YOUR+QR+LINK+HERE" 
                             alt="Your UPI QR Code" 
                             class="w-48 h-48 mx-auto my-2 rounded-lg border border-gray-300"
                             onerror="this.src='https://placehold.co/200x200/eee/333?text=QR+Image+Error'; this.onerror=null;">
                        
                        <p class="text-sm font-medium text-gray-800 text-center">
                            UPI ID: <strong>chrisstylusxspidy@okhd...</strong>
                        </p>
                        <hr class="my-4">
                        <p class="text-md font-semibold text-green-700 text-center">2. Submit for Approval</p>
                        <p class="text-sm text-gray-600 text-center mb-2">After paying, enter the details from your UPI app.</p>
                        <form id="student-recharge-form" class="space-y-3" autocomplete="off">
                            <input type="number" id="student-recharge-amount" inputmode="decimal" placeholder="Amount You Paid (e.g., 200)" class="w-full p-3 border border-gray-300 rounded-lg" required>
                            <input type="text" id="student-recharge-ref" placeholder="UPI Transaction ID (e.g. 2105...)" class="w-full p-3 border border-gray-300 rounded-lg" required>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">Submit for Approval</button>
                        </form>
                    </div>
                </div>

                <button id="student-back-btn" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition mt-8">
                    Back to Main Menu
                </button>
            </div>
            
            <!-- View: QR Card Display (for Printing) -->
            <div id="qr-card-view" class="view">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Student QR Card</h1>
                <div id="qr-card-container" class="w-80 mx-auto border-2 border-gray-300 p-6 rounded-lg bg-white text-center space-y-3">
                    <h2 class="text-xl font-bold text-black">Annual Day Event Card</h2>
                    <div id="qr-card-code" class="flex justify-center p-2">
                        <!-- QR Code will be injected here -->
                    </div>
                    <p id="qr-card-name" class="text-2xl font-semibold text-black"></p>
                    <p id="qr-card-school-id" class="text-lg text-gray-700"></p>
                    <p id="qr-card-balance" class="text-lg font-bold text-green-600"></p>
                </div>
                <div id="qr-card-controls" class="flex gap-4 mt-6">
                    <button id="qr-card-print-btn" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                        Print Card
                    </button>
                    <button id="qr-card-back-btn" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                        Back
                    </button>
                </div>
            </div>
            
            <!-- View: List View (for Admin Reports) -->
            <div id="list-view" class="view">
                <h1 id="list-title" class="text-2xl font-bold text-center text-gray-800 mb-4"></h1>
                <p id="list-total" class="text-center text-xl font-bold text-indigo-600 mb-4"></p>
                <div id="list-container" class="max-h-96 overflow-y-auto border rounded-lg bg-white">
                    <!-- List will be injected here -->
                </div>
                
                <!-- NEW: Gemini Admin Report Analyzer -->
                <div id="admin-analysis-controls" class="mt-4" style="display: none;">
                    <button id="admin-analyze-btn" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition">
                        ✨ Analyze This Report
                    </button>
                    <div id="admin-analysis-box" class="analysis-box" style="display: none;"></div>
                </div>

                <button id="list-back-btn" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition mt-6">
                    Back to Admin
                </button>
            </div>
            
        </div>
    </div>

    <!-- 
      =======================================================================
      === SCRIPT LOADING ORDER: IMPORTANT FOR QR SCANNERS                   ===
      =======================================================================
      Load external libraries *before* our main app module script.
      By placing them here without defer/async, they will block,
      execute, and be available on the global scope.
    -->
    <!-- 1. QR Code Generation Library (for Admin) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- 2. QR Code Scanning Library (for Stalls & Students) -->
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

    <!-- 3. Firebase & Main Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc,
            onSnapshot, collection, query, increment, writeBatch, 
            serverTimestamp, setLogLevel, where, orderBy, limit, getDocs 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        let db, auth, userId, isAuthReady = false;
        let appId = 'default-app-id';
        
        // Firestore Collection References
        let studentsCollection, transactionsCollection, menuItemsCollection, pendingRechargesCollection;

        // QR Scanner instances
        let adminScanner, stallScanner, studentScanner, rechargeScanner; // NEW: Added rechargeScanner
        let currentStallName = '';
        let currentStudentId = ''; // Used by student panel
        let stallCart = {}; // NEW: For stall item quantities
        
        // NEW: Gemini API Configuration
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`; // Key will be provided by the environment
        
        
        // Firestore real-time listener unsubscribe functions
        let unsub = {
            students: null,
            transactions: null,
            stallBalance: null,
            studentBalance: null,
            menuItems: null,
            pendingRecharges: null,
            studentTransactions: null,
            rechargeBalance: null, // NEW: Added listener for manual recharge
        };

        // --- Utility Functions ---

        /**
         * Unsubscribes from all active Firestore listeners
         */
        function unsubscribeAllListeners() {
            Object.values(unsub).forEach(fn => fn?.());
        }

        /**
         * Shows a specific view and hides all others
         */
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            unsubscribeAllListeners();
            stopAllScanners();
            document.querySelector(viewId).style.display = 'block';
        }

        /**
         * Displays a temporary message
         */
        function showMessage(messageId, message, isError = false, timeout = 3000) {
            const el = document.getElementById(messageId);
            if (!el) return;
            el.textContent = message;
            el.className = isError 
                ? 'text-red-600 text-center font-medium p-2' 
                : 'text-green-600 text-center font-medium p-2';
            
            if (timeout > 0) {
                setTimeout(() => {
                    if (el.textContent === message) el.textContent = '';
                }, timeout);
            }
        }

        /**
         * Creates a QR scanner instance lazily
         */
        function createScanner(elementId, onScanSuccess) {
            try {
                // Check if Html5Qrcode is loaded
                if (typeof Html5Qrcode === 'undefined') {
                    throw new Error("Html5Qrcode library is not loaded.");
                }
                
                const html5QrCode = new Html5Qrcode(elementId);
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                const startScan = () => {
                    document.getElementById(elementId).style.display = 'block';
                    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (error) => {
                        // console.warn(`QR scan error: ${error}`);
                    }).catch(err => {
                        console.error(`Failed to start scanner (${elementId}):`, err);
                        showMessage(`${elementId.split('-')[0]}-message`, "Could not start camera. Please give permission.", true);
                    });
                };

                const stopScan = () => {
                    try {
                        if (html5QrCode.isScanning) {
                            html5QrCode.stop();
                        }
                    } catch (e) { /* Ignore */ }
                    document.getElementById(elementId).style.display = 'none';
                };
                
                return { startScan, stopScan };
            } catch (e) {
                console.error("Fatal Error creating scanner:", e);
                // We use alert here because this is a critical failure.
                alert("Error: QR Scanner library failed to load. Please refresh.");
                return null;
            }
        }

        /**
         * Stops all active QR scanners
         */
        function stopAllScanners() {
            adminScanner?.stopScan();
            stallScanner?.stopScan();
            studentScanner?.stopScan();
            rechargeScanner?.stopScan(); // NEW: Stop recharge scanner
        }

        /**
         * Formats a Firestore timestamp
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Just now';
            return timestamp.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        
        /**
         * Logs a transaction to Firestore
         */
        async function logTransaction(studentDocId, studentName, type, amount, stallName) {
            try {
                const txData = {
                    studentDocId, studentName, type,
                    amount, // e.g., 200 (recharge) or -50 (deduction)
                    stallName, timestamp: serverTimestamp()
                };
                await addDoc(transactionsCollection, txData);
            } catch (error) {
                console.error("Failed to log transaction:", error);
            }
        }
        
        // --- NEW: Gemini API Functions ---

        /**
         * Calls the Gemini API with exponential backoff.
         */
        async function callGemini(userQuery, systemInstruction = "", retries = 3, delay = 1000) {
            const apiKey = ""; // This will be injected by the environment
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
            };

            if (systemInstruction) {
                payload.systemInstruction = {
                    parts: [{ text: systemInstruction }]
                };
            }

            try {
                const response = await fetch(`${GEMINI_API_URL}${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        // Throttled, retry with backoff
                        await new Promise(res => setTimeout(res, delay));
                        return callGemini(userQuery, systemInstruction, retries - 1, delay * 2);
                    }
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) {
                    throw new Error("No content in API response.");
                }
                return text;

            } catch (error) {
                console.error("Gemini API call failed:", error);
                return "Error: Could not get analysis from AI.";
            }
        }


        // --- Initialization ---
        
        /**
         * Main app entry point. Runs after all resources are loaded.
         */
        function setupApp() {
            // Setup main menu navigation
            document.getElementById('goto-admin-btn').onclick = setupAdminView;
            document.getElementById('goto-stall-btn').onclick = setupStallView;
            document.getElementById('goto-student-btn').onclick = setupStudentView;
            
            // Start Firebase connection
            initializeFirebase();
        }

        async function initializeFirebase() {
            try {
                // DO NOT EDIT: __firebase_config is a special variable injected by the environment.
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                // DO NOT EDIT: __app_id is a special variable injected by the environment.
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                // Define all collection paths
                const basePath = `/artifacts/${appId}/public/data`;
                studentsCollection = collection(db, `${basePath}/event_wallet_students`);
                transactionsCollection = collection(db, `${basePath}/event_wallet_transactions`);
                menuItemsCollection = collection(db, `${basePath}/event_wallet_menu_items`);
                pendingRechargesCollection = collection(db, `${basePath}/event_wallet_pending_recharges`);

                console.log("Firebase Initialized. App ID:", appId);
                setupAuthListener();
            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('loading-message').textContent = "Error loading app. Check console.";
            }
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("User authenticated:", userId);
                    showView('#main-menu-view'); // Show main menu after auth
                } else {
                    await attemptSignIn();
                }
            });
        }

        async function attemptSignIn() {
            try {
                // DO NOT EDIT: __initial_auth_token is a special variable injected by the environment.
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('loading-message').textContent = "Authentication failed. Please refresh.";
            }
        }

        // --- Admin Mode Functions ---

        function setupAdminView() {
            showView('#admin-view');
            document.getElementById('admin-back-btn').onclick = () => showView('#main-menu-view');
            
            // 1. Approve Pending Recharges
            loadPendingRecharges();
            
            // 2. Manual Cash Recharge (NEW)
            document.getElementById('goto-manual-recharge-btn').onclick = setupManualRechargeView;

            // 3. Register Student
            document.getElementById('register-student-form').onsubmit = handleRegisterSubmit;
            
            // 3. Find Student
            document.getElementById('find-student-form').onsubmit = handleFindStudent;
            
            // 4. Manage Menu
            document.getElementById('add-menu-item-form').onsubmit = handleAddMenuItem;
            loadMenuItemsList();

            // 5. Reports
            document.getElementById('view-all-students-btn').onclick = loadStudentList;
            document.getElementById('view-all-transactions-btn').onclick = loadTransactionList;
            document.getElementById('view-stall-performance-btn').onclick = loadStallPerformanceReport; // NEW
            document.getElementById('list-back-btn').onclick = () => {
                // NEW: Hide analysis controls when going back
                document.getElementById('admin-analysis-controls').style.display = 'none';
                document.getElementById('admin-analysis-box').style.display = 'none';
                showView('#admin-view');
            };
        }
        
        // --- Admin: Pending Recharges (NEW) ---
        
        function loadPendingRecharges() {
            const listEl = document.getElementById('pending-recharges-list');
            // MODIFIED: Removed orderBy("timestamp") to avoid needing a composite index.
            // We will sort in JavaScript instead.
            const q = query(pendingRechargesCollection, where("status", "==", "pending"));
            
            unsub.pendingRecharges = onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    listEl.innerHTML = '<p class="p-2 text-center text-sm text-gray-500">No pending recharges.</p>';
                    return;
                }
                listEl.innerHTML = '';

                // MODIFIED: Sort the documents by timestamp in JavaScript (newest first)
                const docs = querySnapshot.docs.sort((a, b) => {
                    const timeA = a.data().timestamp?.toMillis() || 0;
                    const timeB = b.data().timestamp?.toMillis() || 0;
                    return timeB - timeA;
                });

                // MODIFIED: Iterate over the sorted docs array
                docs.forEach((doc) => {
                    const req = doc.data();
                    const reqId = doc.id;
                    
                    const el = document.createElement('div');
                    el.className = "p-3 bg-white border border-gray-300 rounded-lg";
                    el.innerHTML = `
                        <p class="text-md font-medium text-gray-900">${req.studentName}</p>
                        <p class="text-lg font-bold text-green-600">Amount: ₹${req.amount}</p>
                        <p class="text-sm text-gray-600">Ref ID: ${req.upiRef}</p>
                        <div class="flex gap-2 mt-2">
                            <button data-id="${reqId}" class="approve-btn flex-1 bg-green-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-green-700">Approve</button>
                            <button data-id="${reqId}" class="reject-btn flex-1 bg-red-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-red-700">Reject</button>
                        </div>
                    `;
                    
                    el.querySelector('.approve-btn').onclick = () => approveRecharge(reqId, req.studentDocId, req.studentName, req.amount);
                    el.querySelector('.reject-btn').onclick = () => rejectRecharge(reqId);
                    
                    listEl.appendChild(el);
                });
            }, (error) => {
                console.error("Error loading pending recharges: ", error);
                listEl.innerHTML = '<p class="text-red-500 text-center">Error loading requests.</p>';
            });
        }
        
        async function approveRecharge(rechargeId, studentDocId, studentName, amount) {
            if (!isAuthReady) return;
            try {
                const rechargeRef = doc(pendingRechargesCollection, rechargeId);
                const studentRef = doc(studentsCollection, studentDocId);
                
                // Use a batch write to make it atomic
                const batch = writeBatch(db);
                
                // 1. Update student balance
                batch.update(studentRef, { balance: increment(amount) });
                
                // 2. Mark recharge as approved
                batch.update(rechargeRef, { status: "approved" });
                
                await batch.commit();
                
                // 3. Log the transaction
                await logTransaction(studentDocId, studentName, 'recharge', amount, 'Student Self-Recharge');
                
                showMessage('admin-message', 'Recharge approved!', false);
            } catch (error) {
                console.error("Error approving recharge: ", error);
                showMessage('admin-message', 'Approval failed!', true);
            }
        }

        async function rejectRecharge(rechargeId) {
            try {
                const rechargeRef = doc(pendingRechargesCollection, rechargeId);
                await updateDoc(rechargeRef, { status: "rejected" });
                showMessage('admin-message', 'Recharge rejected.', false);
            } catch (error) {
                console.error("Error rejecting recharge: ", error);
                showMessage('admin-message', 'Rejection failed!', true);
            }
        }

        // --- Admin: Register Student ---

        async function handleRegisterSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) return showMessage('admin-message', 'Database not ready', true);

            const name = document.getElementById('student-name').value;
            const schoolId = document.getElementById('student-school-id').value;
            const initialBalance = parseFloat(document.getElementById('initial-balance').value);

            if (!name || !schoolId || isNaN(initialBalance)) {
                return showMessage('admin-message', 'Please fill all fields correctly', true);
            }

            try {
                const studentData = { name, schoolId, balance: initialBalance, createdAt: serverTimestamp() };
                const docRef = await addDoc(studentsCollection, studentData);
                
                if (initialBalance > 0) {
                    await logTransaction(docRef.id, name, 'recharge', initialBalance, 'Admin Registration');
                }
                
                showMessage('admin-message', 'Student registered successfully!', false);
                document.getElementById('register-student-form').reset();
                showStudentQrCard(docRef.id, name, schoolId, initialBalance);

            } catch (error) {
                console.error("Error registering student:", error);
                showMessage('admin-message', 'Failed to register student', true);
            }
        }
        
        // --- Admin: Find/Re-print Student (NEW) ---
        
        async function handleFindStudent(e) {
            e.preventDefault();
            const queryText = document.getElementById('find-student-query').value.trim();
            const resultsEl = document.getElementById('find-student-results');
            resultsEl.innerHTML = '<p class="text-center text-sm">Searching...</p>';
            
            if (!queryText) {
                resultsEl.innerHTML = '';
                return;
            }
            
            // Note: Firestore doesn't support full-text search. This is a basic "starts-with" search.
            // A more robust solution would use a third-party search like Algolia.
            // For now, we'll just query by School ID as it's more likely to be unique.
            
            try {
                const q = query(studentsCollection, where("schoolId", "==", queryText));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    // If not found by ID, try by name (less efficient)
                    const qName = query(studentsCollection, where("name", "==", queryText));
                    const nameSnapshot = await getDocs(qName);
                    
                    if (nameSnapshot.empty) {
                        resultsEl.innerHTML = '<p class="text-center text-sm text-gray-500">No students found.</p>';
                        return;
                    }
                    displayFindResults(nameSnapshot.docs);
                } else {
                    displayFindResults(querySnapshot.docs);
                }
                
            } catch (error) {
                console.error("Error finding student: ", error);
                resultsEl.innerHTML = '<p class="text-center text-sm text-red-500">Search error.</p>';
            }
        }
        
        function displayFindResults(docs) {
             const resultsEl = document.getElementById('find-student-results');
             resultsEl.innerHTML = '';
             docs.forEach(docSnap => {
                const student = docSnap.data();
                const studentId = docSnap.id;
                
                const el = document.createElement('div');
                el.className = "p-2 bg-white border rounded-lg flex justify-between items-center";
                el.innerHTML = `
                    <div>
                        <p class_l="text-md font-medium">${student.name}</p>
                        <p class="text-sm text-gray-600">${student.schoolId}</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-semibold view-card-btn">View Card</button>
                        <button class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-semibold cash-out-btn">Cash Out</button>
                    </div>
                `;
                // UPDATED: Added multiple buttons
                el.querySelector('.view-card-btn').onclick = () => {
                    showStudentQrCard(studentId, student.name, student.schoolId, student.balance);
                };
                el.querySelector('.cash-out-btn').onclick = () => {
                    setupCashOutView(studentId, student.name, student.balance);
                };
                resultsEl.appendChild(el);
             });
        }

        function showStudentQrCard(studentDocId, name, schoolId, balance) {
            showView('#qr-card-view');
            document.getElementById('qr-card-name').textContent = name;
            document.getElementById('qr-card-school-id').textContent = `ID: ${schoolId}`;
            document.getElementById('qr-card-balance').textContent = `Balance: ₹${balance.toFixed(2)}`;
            
            const qrContainer = document.getElementById('qr-card-code');
            qrContainer.innerHTML = ''; // Clear previous QR
            
            // Check if QRCode library is loaded
            if (typeof QRCode === 'undefined') {
                alert("Error: QR Code generator library failed to load.");
                return;
            }
            
            new QRCode(qrContainer, {
                text: studentDocId, // The QR code just contains the unique Firestore ID
                width: 200, height: 200,
                colorDark : "#000000", colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            
            document.getElementById('qr-card-print-btn').onclick = () => window.print();
            document.getElementById('qr-card-back-btn').onclick = () => showView('#admin-view');
        }

        // --- Admin: Manage Menu (NEW) ---
        
        async function handleAddMenuItem(e) {
            e.preventDefault();
            const stallName = document.getElementById('menu-item-stall-name').value;
            const itemName = document.getElementById('menu-item-name').value;
            const price = parseFloat(document.getElementById('menu-item-price').value);
            
            if (!stallName || !itemName || isNaN(price) || price <= 0) {
                return showMessage('admin-message', 'Please fill all menu fields correctly', true);
            }
            
            try {
                const itemData = { stallName, itemName, price };
                await addDoc(menuItemsCollection, itemData);
                showMessage('admin-message', 'Menu item added!', false);
                document.getElementById('add-menu-item-form').reset();
            } catch (error) {
                console.error("Error adding menu item: ", error);
                showMessage('admin-message', 'Failed to add item', true);
            }
        }
        
        function loadMenuItemsList() {
            const listEl = document.getElementById('menu-items-list');
            // MODIFIED: Removed the secondary orderBy("itemName") to avoid needing a composite index.
            // Ordering by stall name is sufficient for this list.
            const q = query(menuItemsCollection, orderBy("stallName"));
            
            unsub.menuItems = onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    listEl.innerHTML = '<p class="text-center text-sm text-gray-500">No menu items added yet.</p>';
                    return;
                }
                listEl.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const item = doc.data();
                    const itemId = doc.id;
                    
                    const el = document.createElement('div');
                    el.className = "p-2 bg-white border rounded-lg flex justify-between items-center";
                    el.innerHTML = `
                        <div>
                            <p class_l="text-md font-medium">${item.itemName} (₹${item.price})</p>
                            <p class="text-sm text-gray-600">${item.stallName}</p>
                        </div>
                        <button class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-semibold">Delete</button>
                    `;
                    el.querySelector('button').onclick = async () => {
                        if (confirm(`Delete ${item.itemName}?`)) {
                            await deleteDoc(doc(menuItemsCollection, itemId));
                            showMessage('admin-message', 'Item deleted', false);
                        }
                    };
                    listEl.appendChild(el);
                });
            }, (error) => {
                console.error("Error loading menu: ", error);
                listEl.innerHTML = '<p class="text-center text-sm text-red-500">Error loading menu.</p>';
            });
        }
        
        // --- Admin: Reports (Legacy Recharge Removed) ---
        
        // --- NEW: Admin Manual Cash Recharge Functions ---

        function setupManualRechargeView() {
            showView('#manual-recharge-view');
            document.getElementById('recharge-form').style.display = 'none';
            document.getElementById('recharge-scanner-container').style.display = 'block';
            
            document.getElementById('recharge-back-btn').onclick = () => showView('#admin-view');
            document.getElementById('recharge-form').onsubmit = handleManualRechargeSubmit;
            document.getElementById('recharge-cancel-btn').onclick = resetRechargeViewForNextScan;

            if (!rechargeScanner) {
                rechargeScanner = createScanner('recharge-scanner', onRechargeScanSuccess);
            }
            rechargeScanner?.startScan();
            showMessage('recharge-message', '', false);
        }
        
        function onRechargeScanSuccess(studentDocId) {
            rechargeScanner?.stopScan();
            document.getElementById('recharge-scanner-container').style.display = 'none';
            showMessage('recharge-message', 'QR Scanned! Fetching balance...', false);
            
            unsubscribeAllListeners();
            const docRef = doc(studentsCollection, studentDocId);
            
            // Attach a real-time listener to get live balance updates
            unsub.rechargeBalance = onSnapshot(docRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showMessage('recharge-message', 'Invalid Student QR. Please scan again.', true);
                    setTimeout(resetRechargeViewForNextScan, 2000);
                    return;
                }
                
                const student = docSnap.data();
                document.getElementById('recharge-student-name').textContent = student.name;
                document.getElementById('recharge-current-balance').textContent = `₹${student.balance.toFixed(2)}`;
                document.getElementById('recharge-form').style.display = 'block';
                document.getElementById('recharge-amount').focus();
                
                // Store data on the form for the submit handler
                document.getElementById('recharge-form').dataset.studentId = docSnap.id;
                document.getElementById('recharge-form').dataset.studentName = student.name;

            }, (error) => {
                console.error("Error fetching student:", error);
                showMessage('recharge-message', 'Error reading student data. Please try again.', true);
                setTimeout(resetRechargeViewForNextScan, 2000);
            });
        }
        
        async function handleManualRechargeSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const studentDocId = form.dataset.studentId;
            const studentName = form.dataset.studentName;
            const amount = parseFloat(document.getElementById('recharge-amount').value);

            if (isNaN(amount) || amount <= 0) {
                return showMessage('recharge-message', 'Please enter a valid amount.', true);
            }
            
            try {
                const docRef = doc(studentsCollection, studentDocId);
                await updateDoc(docRef, { balance: increment(amount) });
                await logTransaction(studentDocId, studentName, 'recharge', amount, 'Admin Cash Recharge');
                
                showMessage('recharge-message', `Recharge successful!`, false, 2000);
                
                // Reset for next customer after a short delay
                setTimeout(resetRechargeViewForNextScan, 2000);
                
            } catch (error) {
                console.error("Recharge failed:", error);
                showMessage('recharge-message', 'Recharge failed. Please try again.', true);
            }
        }
        
        function resetRechargeViewForNextScan() {
            unsub.rechargeBalance?.();
            document.getElementById('recharge-form').style.display = 'none';
            document.getElementById('recharge-scanner-container').style.display = 'block';
            document.getElementById('recharge-form').reset();
            showMessage('recharge-message', '', false);
            rechargeScanner?.startScan();
        }

        // --- NEW: Admin Cash Out Functions ---

        function setupCashOutView(studentId, name, balance) {
            showView('#cash-out-view');
            showMessage('cash-out-message', '', false);
            
            document.getElementById('cash-out-student-name').textContent = name;
            document.getElementById('cash-out-balance').textContent = `₹${balance.toFixed(2)}`;
            
            const confirmBtn = document.getElementById('confirm-cash-out-btn');
            confirmBtn.textContent = `Confirm Cash Out (₹${balance.toFixed(2)})`;
            confirmBtn.onclick = () => handleCashOutConfirm(studentId, name, balance);

            document.getElementById('cancel-cash-out-btn').onclick = () => showView('#admin-view');
            
            // Disable button if balance is zero
            if (balance <= 0) {
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Balance is already zero';
                confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function handleCashOutConfirm(studentId, name, balance) {
            if (balance <= 0) {
                return showMessage('cash-out-message', 'Balance is already zero.', true);
            }
            
            try {
                const docRef = doc(studentsCollection, studentId);
                // Set balance to 0, not increment
                await updateDoc(docRef, { balance: 0 });
                // Log the refund transaction
                await logTransaction(studentId, name, 'refund', -balance, 'Admin Cash Out');
                
                showMessage('admin-message', 'Cash out successful. Balance set to zero.', false);
                showView('#admin-view');
                
            } catch (error) {
                console.error("Cash out failed:", error);
                showMessage('cash-out-message', 'Cash out failed. Please try again.', true);
            }
        }
        
        // --- Admin: Reports ---

        function loadStudentList() {
            showView('#list-view');
            document.getElementById('list-title').textContent = 'All Student Balances';
            const listEl = document.getElementById('list-container');
            listEl.innerHTML = '<p class="p-4 text-center">Loading students...</p>';
            
            unsubscribeAllListeners();
            const q = query(studentsCollection, orderBy("name"));
            
            unsub.students = onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    listEl.innerHTML = '<p class="p-4 text-center">No students registered yet.</p>';
                    return;
                }
                
                let totalBalance = 0;
                let html = '<ul class="divide-y divide-gray-200">';
                
                querySnapshot.forEach((doc) => {
                    const student = doc.data();
                    totalBalance += student.balance;
                    html += `
                        <li class="py-3 px-4 flex justify-between items-center">
                            <div>
                                <p class="text-md font-medium text-gray-900">${student.name}</p>
                                <p class="text-sm text-gray-500">ID: ${student.schoolId}</p>
                            </div>
                            <p class="text-lg font-semibold text-indigo-600">₹${student.balance.toFixed(2)}</p>
                        </li>
                    `;
                });
                html += '</ul>';
                
                document.getElementById('list-total').textContent = `Total Float: ₹${totalBalance.toFixed(2)}`;
                listEl.innerHTML = html;
                
            }, (error) => {
                console.error("Error fetching students:", error);
                listEl.innerHTML = '<p class="p-4 text-center text-red-500">Error loading students.</p>';
            });
        }
        
        function loadTransactionList() {
            showView('#list-view');
            document.getElementById('list-title').textContent = 'Transaction History';
            document.getElementById('list-total').textContent = '';
            const listEl = document.getElementById('list-container');
            listEl.innerHTML = '<p class="p-4 text-center">Loading transactions...</p>';
            
            unsubscribeAllListeners();
            const q = query(transactionsCollection, orderBy("timestamp", "desc"));
            
            unsub.transactions = onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    listEl.innerHTML = '<p class="p-4 text-center">No transactions yet.</p>';
                    return;
                }
                
                let html = '<ul class="divide-y divide-gray-200">';
                querySnapshot.forEach((doc) => {
                    const tx = doc.data();
                    const isRecharge = tx.type === 'recharge';
                    const amountClass = isRecharge ? 'text-green-600' : 'text-red-600';
                    const amountSign = isRecharge ? '+' : '';
                    
                    html += `
                        <li class="py-3 px-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-md font-medium text-gray-900">${tx.studentName}</p>
                                    <p class="text-sm text-gray-500">From: ${tx.stallName}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-semibold ${amountClass}">
                                        ${amountSign}₹${Math.abs(tx.amount).toFixed(2)}
                                    </p>
                                    <p class="text-xs text-gray-500">${formatTimestamp(tx.timestamp)}</p>
                                </div>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                listEl.innerHTML = html;
                
            }, (error) => {
                console.error("Error fetching transactions:", error);
                listEl.innerHTML = '<p class="p-4 text-center text-red-500">Error loading transactions.</p>';
            });
        }
        
        // --- NEW: Admin Stall Performance Report ---

        async function loadStallPerformanceReport() {
            showView('#list-view');
            document.getElementById('list-title').textContent = 'Stall Performance Report';
            const listEl = document.getElementById('list-container');
            const totalEl = document.getElementById('list-total');
            listEl.innerHTML = '<p class="p-4 text-center">Loading transactions...</p>';
            totalEl.textContent = 'Calculating...';
            
            // NEW: Hide analysis controls
            const analysisControls = document.getElementById('admin-analysis-controls');
            const analysisBox = document.getElementById('admin-analysis-box');
            analysisControls.style.display = 'none';
            analysisBox.style.display = 'none';
            
            unsubscribeAllListeners(); // This is a one-time report, no snapshot
            
            try {
                // We only care about deductions (sales)
                const q = query(transactionsCollection, where("type", "==", "deduction"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    listEl.innerHTML = '<p class="p-4 text-center">No stall sales recorded yet.</p>';
                    totalEl.textContent = 'Total Revenue: ₹0.00';
                    return;
                }
                
                const stallTotals = {};
                let grandTotal = 0;
                
                // Aggregate sales by stall name
                querySnapshot.forEach((doc) => {
                    const tx = doc.data();
                    const stallName = tx.stallName || 'Unknown Stall';
                    const amount = Math.abs(tx.amount);
                    
                    stallTotals[stallName] = (stallTotals[stallName] || 0) + amount;
                    grandTotal += amount;
                });
                
                // Sort stalls from highest to lowest revenue
                const sortedStalls = Object.entries(stallTotals).sort((a, b) => b[1] - a[1]);

                let html = '<ul class="divide-y divide-gray-200">';
                sortedStalls.forEach(([name, total]) => {
                    html += `
                        <li class="py-3 px-4 flex justify-between items-center">
                            <p class="text-md font-medium text-gray-900">${name}</p>
                            <p class="text-lg font-semibold text-indigo-600">₹${total.toFixed(2)}</p>
                        </li>
                    `;
                });
                html += '</ul>';
                
                totalEl.textContent = `Total Revenue: ₹${grandTotal.toFixed(2)}`;
                listEl.innerHTML = html;
                
                // NEW: Show and setup Gemini analysis button
                analysisControls.style.display = 'block';
                analysisBox.style.display = 'none';
                const analyzeBtn = document.getElementById('admin-analyze-btn');
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = '✨ Analyze This Report';
                
                analyzeBtn.onclick = async () => {
                    analyzeBtn.disabled = true;
                    analyzeBtn.textContent = 'Analyzing...';
                    analysisBox.style.display = 'block';
                    analysisBox.innerHTML = '<p class="text-center">Asking AI for insights...</p>';
                    
                    // Format data for the prompt
                    const dataString = sortedStalls.map(([name, total]) => `${name}: ₹${total.toFixed(2)}`).join(', ');
                    const systemInstruction = "You are a helpful event analyst. Provide a brief, insightful summary (2-3 bullet points) based on the provided sales data. Focus on successes and potential suggestions for a school event.";
                    const userQuery = `Here is the sales data from our school event: ${dataString}. Grand total revenue is ₹${grandTotal.toFixed(2)}. What are the key takeaways?`;
                    
                    const analysis = await callGemini(userQuery, systemInstruction);
                    analysisBox.textContent = analysis;
                    analyzeBtn.disabled = false; // Re-enable in case they want to run it again
                    analyzeBtn.textContent = '✨ Re-Analyze Report';
                };

            } catch (error) {
                console.error("Error generating stall report:", error);
                listEl.innerHTML = '<p class="p-4 text-center text-red-500">Error loading report.</p>';
                totalEl.textContent = 'Error';
            }
        }

        // --- Stall Mode Functions ---
        
        function setupStallView() {
            showView('#stall-view');
            // MODIFIED: This code was moved from admin
            document.getElementById('stall-back-btn').onclick = () => showView('#main-menu-view');
            document.getElementById('stall-start-btn').onclick = startStallSession;
            document.getElementById('stall-payment-form').onsubmit = handleStallPaymentSubmit;
            document.getElementById('stall-cancel-btn').onclick = resetStallViewForNextScan;
        }
        
        async function startStallSession() {
            currentStallName = document.getElementById('stall-name').value;
            if (!currentStallName) {
                return showMessage('stall-message', 'Please enter a stall name', true);
            }
            document.getElementById('stall-setup').style.display = 'none';
            document.getElementById('stall-active').style.display = 'block';
            document.getElementById('stall-active-name').textContent = `Stall: ${currentStallName}`;
            
            // REMOVED: The two incorrect lines that were here and causing an error.

            // Load this stall's menu items
            await loadStallMenu(currentStallName);
            
            if (!stallScanner) {
                stallScanner = createScanner('stall-scanner', onStallScanSuccess);
            }
            stallScanner?.startScan();
        }
        
        async function loadStallMenu(stallName) {
            const menuEl = document.getElementById('stall-item-list');
            menuEl.innerHTML = '';
            
            // MODIFIED: Removed orderBy("itemName") to avoid needing a composite index.
            // We will sort in JavaScript instead.
            const q = query(menuItemsCollection, where("stallName", "==", stallName));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                // MODIFIED: Show message in the new item list container
                menuEl.innerHTML = '<p class="text-center text-sm text-gray-500">No menu items found for this stall. Admin needs to add them.</p>';
                return;
            }
            
            // MODIFIED: Sort the results by item name in JavaScript
            const docs = querySnapshot.docs.sort((a, b) => 
                a.data().itemName.localeCompare(b.data().itemName)
            );

            // MODIFIED: Iterate over the sorted docs array and create new quantity UI
            docs.forEach((doc) => {
                const item = doc.data();
                const itemId = doc.id;
                const itemPrice = item.price;
                
                const el = document.createElement('div');
                el.className = "flex justify-between items-center p-2 bg-white border rounded-lg";
                el.dataset.itemId = itemId;
                el.dataset.itemPrice = itemPrice;

                el.innerHTML = `
                    <span class="font-medium">${item.itemName} (₹${itemPrice})</span>
                    <div class="flex items-center gap-2">
                        <button type="button" class="qty-decrease bg-red-100 text-red-700 w-7 h-7 rounded-full text-lg font-bold flex items-center justify-center">-</button>
                        <span class="qty-value text-lg font-bold w-6 text-center">0</span>
                        <button type="button" class="qty-increase bg-green-100 text-green-700 w-7 h-7 rounded-full text-lg font-bold flex items-center justify-center">+</button>
                    </div>
                `;

                // Add event listeners for new buttons
                el.querySelector('.qty-decrease').onclick = () => updateStallCart(el, itemId, itemPrice, -1);
                el.querySelector('.qty-increase').onclick = () => updateStallCart(el, itemId, itemPrice, 1);

                menuEl.appendChild(el);
            });
        }

        /**
         * NEW: Resets the stall cart and UI
         */
        function resetStallCart() {
            stallCart = {};
            document.querySelectorAll('#stall-item-list .qty-value').forEach(el => {
                el.textContent = '0';
            });
            updateStallTotal();
        }

        /**
         * NEW: Updates item quantity in the cart
         */
        function updateStallCart(itemElement, itemId, itemPrice, change) {
            if (!stallCart[itemId]) {
                stallCart[itemId] = { qty: 0, price: itemPrice };
            }

            stallCart[itemId].qty += change;

            if (stallCart[itemId].qty < 0) {
                stallCart[itemId].qty = 0;
            }
            
            // Update the UI for this specific item
            itemElement.querySelector('.qty-value').textContent = stallCart[itemId].qty;
            
            // Recalculate and update the total
            updateStallTotal();
        }

        /**
         * NEW: Recalculates and displays the stall's total
         */
        function updateStallTotal() {
            let total = 0;
            for (const itemId in stallCart) {
                total += stallCart[itemId].qty * stallCart[itemId].price;
            }

            const formattedTotal = `₹${total.toFixed(2)}`;
            document.getElementById('stall-total-amount').textContent = formattedTotal;
            
            // Update payment button text
            const confirmBtn = document.getElementById('stall-confirm-payment-btn');
            confirmBtn.textContent = `Confirm Payment (${formattedTotal})`;
            
            // Store total on the form for submission
            document.getElementById('stall-payment-form').dataset.paymentTotal = total;
        }
        
        function resetStallViewForNextScan() {
            unsub.stallBalance?.();
            document.getElementById('stall-payment-form').style.display = 'none';
            document.getElementById('stall-scanner-container').style.display = 'block';
            document.getElementById('stall-payment-form').reset();
            showMessage('stall-message', '', false);
            
            // NEW: Reset cart quantities and total
            resetStallCart();

            stallScanner?.startScan();
        }

        function onStallScanSuccess(studentDocId) {
            // NEW: Read total from the form's dataset
            const totalAmount = parseFloat(document.getElementById('stall-payment-form').dataset.paymentTotal) || 0;
            
            // NEW: Check if cart is empty
            if (totalAmount <= 0) {
                showMessage('stall-message', 'Please add items to the cart first.', true, 2000);
                return; // Don't stop the scanner, let them try again
            }

            stallScanner?.stopScan();
            document.getElementById('stall-scanner-container').style.display = 'none';
            showMessage('stall-message', 'QR Scanned! Fetching balance...', false);
            
            unsubscribeAllListeners();
            const docRef = doc(studentsCollection, studentDocId);
            
            // Attach a real-time listener to get live balance updates
            unsub.stallBalance = onSnapshot(docRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showMessage('stall-message', 'Invalid Student QR. Please scan again.', true);
                    setTimeout(resetStallViewForNextScan, 2000);
                    return;
                }
                
                const student = docSnap.data();
                document.getElementById('payment-student-name').textContent = student.name;
                document.getElementById('payment-current-balance').textContent = `₹${student.balance.toFixed(2)}`;
                document.getElementById('stall-payment-form').style.display = 'block';
                // REMOVED: document.getElementById('payment-amount').focus();
                
                // Store data on the form for the submit handler
                document.getElementById('stall-payment-form').dataset.studentId = docSnap.id;
                document.getElementById('stall-payment-form').dataset.studentName = student.name;
                document.getElementById('stall-payment-form').dataset.currentBalance = student.balance;

            }, (error) => {
                console.error("Error fetching student:", error);
                showMessage('stall-message', 'Error reading student data. Please try again.', true);
                setTimeout(resetStallViewForNextScan, 2000);
            });
        }
        
        async function handleStallPaymentSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const studentDocId = form.dataset.studentId;
            const studentName = form.dataset.studentName;
            const currentBalance = parseFloat(form.dataset.currentBalance);
            
            // MODIFIED: Read amount from dataset, not an input field
            const amount = parseFloat(form.dataset.paymentTotal);
            
            if (isNaN(amount) || amount <= 0) {
                showMessage('stall-message', 'Cart is empty. Please add items.', true);
                return resetStallViewForNextScan();
            }
            
            if (amount > currentBalance) {
                return showMessage('stall-message', 'Insufficient balance!', true);
            }
            
            try {
                const docRef = doc(studentsCollection, studentDocId);
                await updateDoc(docRef, { balance: increment(-amount) });
                await logTransaction(studentDocId, studentName, 'deduction', -amount, currentStallName);
                
                const newBalance = currentBalance - amount;
                showMessage('stall-message', `Payment successful! New balance: ₹${newBalance.toFixed(2)}`, false, 2000);
                
                // Reset for next customer after a short delay
                setTimeout(resetStallViewForNextScan, 2000);
                
            } catch (error) {
                console.error("Payment failed:", error);
                showMessage('stall-message', 'Payment failed. Please try again.', true);
            }
        }
        
        // --- Student Mode Functions ---
        
        function setupStudentView() {
            showView('#student-view');
            document.getElementById('student-login-view').style.display = 'block';
            document.getElementById('student-dashboard-view').style.display = 'none';
            document.getElementById('student-recharge-portal').style.display = 'none';
            
            document.getElementById('student-scan-login-btn').onclick = setupStudentScanLogin;
            document.getElementById('student-scan-cancel-btn').onclick = () => {
                studentScanner?.stopScan();
                document.getElementById('student-scanner-controls').style.display = 'none';
            };
            document.getElementById('student-recharge-btn').onclick = () => {
                document.getElementById('student-recharge-portal').style.display = 'block';
            };
            document.getElementById('student-back-btn').onclick = () => showView('#main-menu-view');
            document.getElementById('student-recharge-form').onsubmit = handleStudentRechargeSubmit;
            
            // NEW: Setup student analysis button
            const analysisBtn = document.getElementById('student-analyze-btn');
            const analysisBox = document.getElementById('student-analysis-box');
            analysisBtn.style.display = 'none'; // Hide until logged in
            analysisBox.style.display = 'none';
            
            analysisBtn.onclick = async () => {
                if (!currentStudentId) return;
                
                analysisBtn.disabled = true;
                analysisBtn.textContent = 'Analyzing...';
                analysisBox.style.display = 'block';
                analysisBox.innerHTML = '<p class="text-center">Thinking...</p>';
                
                // Fetch recent transactions for analysis
                const q = query(transactionsCollection, 
                                where("studentDocId", "==", currentStudentId),
                                orderBy("timestamp", "desc"), 
                                limit(10));
                const querySnapshot = await getDocs(q);
                
                let dataString = 'No transactions yet.';
                if (!querySnapshot.empty) {
                    dataString = querySnapshot.docs.map(doc => {
                        const tx = doc.data();
                        return `${tx.amount < 0 ? 'Spent' : 'Recharged'} ₹${Math.abs(tx.amount)} at ${tx.stallName}`;
                    }).join(', ');
                }
                
                const systemInstruction = "You are a fun, friendly school event guide. Provide a 1-2 sentence summary of the student's spending and a fun tip for the rest of the event. Be encouraging, use emojis, and keep it under 50 words.";
                const userQuery = `Here is my recent spending: ${dataString}. What do you think?`;
                
                const analysis = await callGemini(userQuery, systemInstruction);
                analysisBox.textContent = analysis;
                analysisBtn.disabled = false;
                analysisBtn.textContent = '✨ Analyze My Spending Again';
            };
        }
        
        function setupStudentScanLogin() {
            if (!studentScanner) {
                studentScanner = createScanner('student-scanner', onStudentLoginScan);
            }
            studentScanner?.startScan();
            document.getElementById('student-scanner-controls').style.display = 'block';
            showMessage('student-message', '', false);
        }

        async function onStudentLoginScan(studentDocId) {
            studentScanner?.stopScan();
            document.getElementById('student-scanner-controls').style.display = 'none';
            showMessage('student-message', 'Card scanned! Loading your dashboard...', false);

            try {
                const docRef = doc(studentsCollection, studentDocId);
                unsubscribeAllListeners(); // Stop any previous listeners
                
                currentStudentId = studentDocId; // Save for recharge form
                
                // Listen for real-time balance updates
                unsub.studentBalance = onSnapshot(docRef, (docSnap) => {
                    if (!docSnap.exists()) {
                        showMessage('student-message', 'Invalid Student QR Code', true);
                        currentStudentId = '';
                        return;
                    }
                    
                    const student = docSnap.data();
                    document.getElementById('student-dash-name').textContent = student.name;
                    document.getElementById('student-dash-balance').textContent = `₹${student.balance.toFixed(2)}`;
                    
                    document.getElementById('student-login-view').style.display = 'none';
                    document.getElementById('student-dashboard-view').style.display = 'block';
                    showMessage('student-message', '', false);
                    
                    // NEW: Show analysis button
                    document.getElementById('student-analyze-btn').style.display = 'block';
                    document.getElementById('student-analysis-box').style.display = 'none';
                    document.getElementById('student-analyze-btn').disabled = false;
                    document.getElementById('student-analyze-btn').textContent = '✨ Analyze My Spending';
                });
                
                // Load recent transactions
                loadRecentTransactions(studentDocId);

            } catch (error) {
                console.error("Error checking balance:", error);
                showMessage('student-message', 'Could not read QR code', true);
            }
        }
        
        function loadRecentTransactions(studentDocId) {
            const listEl = document.getElementById('student-dash-transactions');
            listEl.innerHTML = '<p class="p-2 text-center text-sm">Loading recent transactions...</p>';
            
            const q = query(transactionsCollection, 
                            where("studentDocId", "==", studentDocId),
                            orderBy("timestamp", "desc"), 
                            limit(5));
            
            unsub.studentTransactions = onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    listEl.innerHTML = '<p class="p-2 text-center text-sm text-gray-500">No transactions found.</p>';
                    return;
                }
                
                let html = '<ul class="divide-y divide-gray-200">';
                querySnapshot.forEach((doc) => {
                    const tx = doc.data();
                    const isRecharge = tx.type === 'recharge';
                    const amountClass = isRecharge ? 'text-green-600' : 'text-red-600';
                    const amountSign = isRecharge ? '+' : '';
                    
                    html += `
                        <li class="py-2 px-1">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm font-medium text-gray-800">${tx.stallName}</p>
                                    <p class="text-xs text-gray-500">${formatTimestamp(tx.timestamp)}</p>
                                </div>
                                <p class="text-md font-semibold ${amountClass}">
                                    ${amountSign}₹${Math.abs(tx.amount).toFixed(2)}
                                </p>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                listEl.innerHTML = html;
                
            }, (error) => {
                console.error("Error fetching recent transactions:", error);
                listEl.innerHTML = '<p class="p-2 text-center text-sm text-red-500">Could not load transactions.</p>';
            });
        }
        
        async function handleStudentRechargeSubmit(e) {
            e.preventDefault();
            if (!currentStudentId) {
                return showMessage('student-message', 'Error: Student not logged in.', true);
            }
            
            const amount = parseFloat(document.getElementById('student-recharge-amount').value);
            const upiRef = document.getElementById('student-recharge-ref').value.trim();
            const studentName = document.getElementById('student-dash-name').textContent;
            
            if (!upiRef || isNaN(amount) || amount <= 0) {
                return showMessage('student-message', 'Please enter a valid amount and UPI ID', true);
            }
            
            try {
                // Check if this UPI ID has already been used
                const q = query(pendingRechargesCollection, where("upiRef", "==", upiRef));
                const existing = await getDocs(q);
                if (!existing.empty) {
                    return showMessage('student-message', 'This UPI Transaction ID has already been submitted.', true);
                }
                
                // Submit the request
                const rechargeRequest = {
                    studentDocId: currentStudentId,
                    studentName: studentName,
                    amount: amount,
                    upiRef: upiRef,
                    status: "pending",
                    timestamp: serverTimestamp()
                };
                
                await addDoc(pendingRechargesCollection, rechargeRequest);
                
                showMessage('student-message', 'Request submitted! Awaiting admin approval.', false);
                document.getElementById('student-recharge-form').reset();
                document.getElementById('student-recharge-portal').style.display = 'none';
                
            } catch (error) {
                console.error("Error submitting recharge request: ", error);
                showMessage('student-message', 'Failed to submit request. Please try again.', true);
            }
        }

        // --- App Entry Point ---
        // MODIFIED: Use 'window.onload' to ensure all external scripts, including
        // the QR scanner libraries, are fully loaded before the app starts.
        // This is more robust than 'DOMContentLoaded'.
        window.onload = setupApp;

    </script>
</body>
</html>

